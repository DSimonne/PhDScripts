# Run analysis on 100 runs without support 

````bash
(devel.p9) p9-07:50_Ar/S1410/pynxraw % python pynx-cdi-analysis.py S1410_pynx_norm_128_300_294_1_1_1-* modes = 1
****************************************************************************
* hwloc 2.1.0 received invalid information from the operating system.
*
* Group0 (cpuset 0x0000000f,0xffffffff,0xfffffff0) intersects with Package (P#0 cpuset 0xffffffff,0xfffffff0 nodeset 0x00000001) without inclusion!
* Error occurred in topology.c line 1443
*
* The following FAQ entry in the hwloc documentation may help:
*   What should I do when hwloc reports "operating system" warnings?
* Otherwise please report this error message to the hwloc user's mailing list,
* along with the files generated by the hwloc-gather-topology script.
* 
* hwloc will now ignore this invalid topology information and continue.
****************************************************************************
--------------------------------------------------------------------------
No OpenFabrics connection schemes reported that they were able to be
used on a specific port.  As such, the openib BTL (OpenFabrics
support) will be disabled for this port.

  Local host:           p9-07
  Local device:         mlx5_0
  Local port:           1
  CPCs attempted:       udcm
--------------------------------------------------------------------------
Importing data files
Loading: S1410_pynx_norm_128_300_294_1_1_1-2020-12-22T16-16-48_Run0014_LLKf000.2132_LLK8512288928.0319_SupportThreshold0.13078.cxi
Loading: S1410_pynx_norm_128_300_294_1_1_1-2020-12-22T16-29-33_Run0026_LLKf000.2166_LLK7997853755.9509_SupportThreshold0.12041.cxi
Loading: S1410_pynx_norm_128_300_294_1_1_1-2020-12-22T16-30-19_Run0027_LLKf000.2119_LLK8779186010.3607_SupportThreshold0.13452.cxi
Loading: S1410_pynx_norm_128_300_294_1_1_1-2020-12-22T16-37-14_Run0034_LLKf000.2027_LLK7995026707.6492_SupportThreshold0.12991.cxi
Loading: S1410_pynx_norm_128_300_294_1_1_1-2020-12-22T16-40-51_Run0039_LLKf000.2084_LLK33826723098.7549_SupportThreshold0.13959.cxi
Loading: S1410_pynx_norm_128_300_294_1_1_1-2020-12-22T16-41-18_Run0040_LLKf000.2010_LLK9488169550.8957_SupportThreshold0.13666.cxi
Loading: S1410_pynx_norm_128_300_294_1_1_1-2020-12-22T16-49-31_Run0053_LLKf000.2019_LLK9449523091.3162_SupportThreshold0.13662.cxi
Loading: S1410_pynx_norm_128_300_294_1_1_1-2020-12-22T16-55-21_Run0061_LLKf000.2251_LLK154730195999.1455_SupportThreshold0.13691.cxi
Loading: S1410_pynx_norm_128_300_294_1_1_1-2020-12-22T17-03-40_Run0072_LLKf000.2217_LLK8201043009.7580_SupportThreshold0.13229.cxi
Loading: S1410_pynx_norm_128_300_294_1_1_1-2020-12-22T17-05-55_Run0076_LLKf000.2227_LLK23164911270.1416_SupportThreshold0.12852.cxi
Calculating modes from the imported objects
Matching arrays against the first one [S1410_pynx_norm_128_300_294_1_1_1-2020-12-22T16-41-18_Run0040_LLKf000.2010_LLK9488169550.8957_SupportThreshold0.13666.cxi] - this may take a while
R_match(0, 1) = 71.320% [8 arrays remaining]
R_match(0, 2) = 67.755% [7 arrays remaining]
R_match(0, 3) = 75.555% [6 arrays remaining]
R_match(0, 4) = 65.638% [5 arrays remaining]
R_match(0, 5) = 70.894% [4 arrays remaining]
R_match(0, 6) = 81.192% [3 arrays remaining]
R_match(0, 7) = 77.720% [2 arrays remaining]
R_match(0, 8) = 67.639% [1 arrays remaining]
R_match(0, 9) = 73.483% [0 arrays remaining]
Elapsed time:   80.3s
Analysing modes
First mode represents 74.783%
Saving modes analysis to: modes.h5
````

# New PyNX run with new support, 50 runs
````bash
(pynx-gap.p9) p9-07:50_Ar/S1410/pynxraw % pwd
/home/esrf/simonne/Documents/Pt_p2/50_Ar/S1410/pynxraw
(pynx-gap.p9) p9-07:50_Ar/S1410/pynxraw % deactivate 
p9-07:50_Ar/S1410/pynxraw % cd 
p9-07:~ % cd Documents/id01_david/Pt_p2/50_Ar/S1410/pynxraw/
p9-07:50_Ar/S1410/pynxraw % source /data/id01/inhouse/richard/pynx-gap.p9/bin/activate
(pynx-gap.p9) p9-07:50_Ar/S1410/pynxraw % python pynx-id01cdi.py pynx-cdi-input_50.txt
/data/id01/inhouse/richard/pynx-gap.p9/lib/python3.8/site-packages/skcuda/cublas.py:284: UserWarning: creating CUBLAS context to get version number
  warnings.warn('creating CUBLAS context to get version number')
Using parameters file:  pynx-cdi-input_50.txt
data S1410_pynx_norm_128_300_294_1_1_1.npz
mask S1410_maskpynx_norm_128_300_294_1_1_1.npz
data2cxi True
auto_center_resize False
support filter_sig5_t20_mask_0.2.npz
support_threshold 0.1,0.2
support_only_shrink False
support_update_period 20
support_smooth_width_begin 2
support_smooth_width_end 1
support_post_expand 1,-2,1
mask_interp 8,2
confidence_interval_factor_mask 0.5,1.2
psf True
nb_raar 1000
nb_hio 400
nb_er 300
nb_ml 0
nb_run 50
nb_run_keep 5
zero_mask False
crop_output 0
positivity False
beta 0.9
detwin False
rebin 1,1,1
detector_distance 0.84
pixel_size_detector 55e-6
wavelength 1.3775e-10
verbose 100
output_format cxi
live_plot False

Loading data:  S1410_pynx_norm_128_300_294_1_1_1.npz
Finished loading iobs data, with size: 11289600
Data CXI file already exists, not overwriting:  S1410_pynx_norm_128_300_294_1_1_1.cxi
CDI runner: preparing processing unit
Computing FFT speed for available CUDA GPU[ranking by fft, fft_shape=(16, 400, 400)]:
                                        Tesla V100-SXM2-32GB: 32256Mb ,1528.13 Gflop/s
                                        Tesla V100-SXM2-32GB: 32256Mb , 183.75 Gflop/s
Using CUDA GPU: Tesla V100-SXM2-32GB
Loading mask from:  S1410_maskpynx_norm_128_300_294_1_1_1.npz
Initialized mask, with 793641 pixels masked ( 7.030%)
Rebinning Iobs with rebin=(1,1,1)
Ignoring rebin=1
Loading support from:  filter_sig5_t20_mask_0.2.npz
Initialized support  (128, 300, 294) , with 87823 pixels ( 0.778%)
Centering & reshaping data: (128, 300, 294) -> (128, 300, 294)
````

# New analysis on the 50 runs
````bash
(devel.p9) p9-07:50_Ar/S1410/pynxraw % python pynx-cdi-analysis.py S1410_pynx_norm_128_300_294_1_1_1-* modes = 1
****************************************************************************
* hwloc 2.1.0 received invalid information from the operating system.
*
* Group0 (cpuset 0x0000000f,0xffffffff,0xfffffff0) intersects with Package (P#0 cpuset 0xffffffff,0xfffffff0 nodeset 0x00000001) without inclusion!
* Error occurred in topology.c line 1443
*
* The following FAQ entry in the hwloc documentation may help:
*   What should I do when hwloc reports "operating system" warnings?
* Otherwise please report this error message to the hwloc user's mailing list,
* along with the files generated by the hwloc-gather-topology script.
* 
* hwloc will now ignore this invalid topology information and continue.
****************************************************************************
--------------------------------------------------------------------------
No OpenFabrics connection schemes reported that they were able to be
used on a specific port.  As such, the openib BTL (OpenFabrics
support) will be disabled for this port.

  Local host:           p9-07
  Local device:         mlx5_0
  Local port:           1
  CPCs attempted:       udcm
--------------------------------------------------------------------------
Importing data files
Loading: S1410_pynx_norm_128_300_294_1_1_1-2020-12-22T23-33-45_Run0009_LLKf000.2510_LLK8039075136.1847_SupportThreshold0.13194.cxi
Loading: S1410_pynx_norm_128_300_294_1_1_1-2020-12-22T23-42-35_Run0017_LLKf000.2576_LLK7812730073.9288_SupportThreshold0.11292.cxi
Loading: S1410_pynx_norm_128_300_294_1_1_1-2020-12-22T23-48-14_Run0023_LLKf000.2326_LLK8061234951.0193_SupportThreshold0.11834.cxi
Loading: S1410_pynx_norm_128_300_294_1_1_1-2020-12-23T00-01-12_Run0038_LLKf000.2560_LLK7909156084.0607_SupportThreshold0.11777.cxi
Loading: S1410_pynx_norm_128_300_294_1_1_1-2020-12-23T00-04-35_Run0044_LLKf000.2510_LLK8125532269.4778_SupportThreshold0.12348.cxi
Calculating modes from the imported objects
Matching arrays against the first one [S1410_pynx_norm_128_300_294_1_1_1-2020-12-22T23-48-14_Run0023_LLKf000.2326_LLK8061234951.0193_SupportThreshold0.11834.cxi] - this may take a while
R_match(0, 1) = 69.377% [3 arrays remaining]
R_match(0, 2) = 76.061% [2 arrays remaining]
R_match(0, 3) = 61.900% [1 arrays remaining]
R_match(0, 4) = 68.953% [0 arrays remaining]
Elapsed time:   35.0s
Analysing modes
First mode represents 80.305%
Saving modes analysis to: modes.h5
````
We gained a few percents

# Launch strain
````bash
(linux.BCDI_MI) david@ord00003:~/Documents/PhD/PhDScripts/Pt_p2/50_Ar/S1410/pynxraw$ python strain_old.py 
/home/david/Documents/PhD/PhDScripts/Pt_p2/50_Ar/S1410/pynxraw/modes.h5
Initial data size: ( 128 , 300 , 294 )
FFT size before accounting for binning (128, 300, 294)
Binning used during phasing: (1, 1, 1)
Padding back to original FFT size (128, 300, 294)
Data shape used for orthogonalization and plotting: ( 186 , 182 , 200 )

Averaging using 1 candidate reconstructions

Opening  /home/david/Documents/PhD/PhDScripts/Pt_p2/50_Ar/S1410/pynxraw/modes.h5
This reconstruction will serve as reference object.

Average performed over  1 reconstructions

Extent of the phase over an extended support (ceil(phase range))~  55 (rad)
Gradient: Phase_ramp_z, Phase_ramp_y, Phase_ramp_x: ( -0.004 0.605 -0.366 ) rad
Max FFT= 1924577.4381292914
Apodization using a 3d Blackman window
Max apodized FFT after normalization = 1924577.4381292914

Shape before orthogonalization (186, 182, 200)
Real space pixel size (z, y, x) based on initial FFT shape: ( 6.08 nm, 10.95 nm, 11.18 nm )
Tilt, pixel_y, pixel_x based on actual array shape: ( 0.0076 deg, 90.66 um, 80.85 um)
New real space pixel size (z, y, x) based on actual array shape: ( 6.08  nm, 10.95 nm, 11.18 nm )
using SIXS geometry
rocking angle is mu, with beta non zero
VTK spacing : 5.00 nm
Angle between q and y = 71.79132269042893 deg
Angle with y in zy plane -45.36658787319518 deg
Angle with y in xy plane -70.76682162800394 deg
Angle with z in xz plane 109.46236623829827 deg
Normalized wavevector transfer [z, y, x]: [-0.31650317  0.31247879  0.89564655]
Wavevector transfer: (angstroms) 2.6627
Atomic plane distance: (angstroms) 2.3597 angstroms
center of mass at (z, y, x): ( 93.65 , 87.41 , 96.46 )
center of mass offset: ( -1 , 4 , 4 ) pixels
Gradient: Phase_ramp_z, Phase_ramp_y, Phase_ramp_x: ( 0.000 -0.005 -0.001 ) rad

Aligning Q along  y : [0 1 0]
Rotating back the crystal in laboratory frame
Voxel size:  5.00 nm
Final data shape: 200 200 200
Phase extent before and after thresholding: 12.117263207098635 2.2645313195235692
phase.max() =  1.0057132145704262 , at coordinates  42 46 85
End of script
````